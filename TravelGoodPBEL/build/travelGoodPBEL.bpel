<?xml version="1.0" encoding="UTF-8" ?>
<process
    name="travelGoodPBEL"
    targetNamespace="http://enterprise.netbeans.org/bpel/TravelGoodPBEL/travelGoodPBEL"
    xmlns:tns="http://enterprise.netbeans.org/bpel/TravelGoodPBEL/travelGoodPBEL"
    xmlns:xs="http://www.w3.org/2001/XMLSchema"
    xmlns:xsd="http://www.w3.org/2001/XMLSchema"
    xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
    xmlns:sxt="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/Trace" 
    xmlns:sxed="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/Editor2"
    xmlns:sxat="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/Attachment"
    xmlns:sxeh="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/ErrorHandling" xmlns:ns0="urn://types.airlineReservation.imm.dtu.dk" xmlns:ns1="http://travelGood.ws">
    <import namespace="http://travelGood.ws" location="travelGood.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="urn://airlineReservation.imm.dtu.dk" location="http://localhost:8080/AirlineReservation/AirlineReservationService?wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <partnerLinks>
        <partnerLink name="PartnerLink2" xmlns:tns="urn://airlineReservation.imm.dtu.dk" partnerLinkType="tns:AirlineReservationLink" partnerRole="AirlineReservationRole"/>
        <partnerLink name="PartnerLink1" xmlns:tns="http://travelGood.ws" partnerLinkType="tns:travelGood" myRole="travelGoodPortTypeRole"/>
    </partnerLinks>
    <variables>
        <variable name="CancelItineraryOut1" messageType="ns1:cancelItineraryResponse"/>
        <variable name="CancelItineraryOut" messageType="ns1:cancelItineraryResponse"/>
        <variable name="CancelItineraryIn" messageType="ns1:cancelItineraryRequest"/>
        <variable name="AddHotelOut" messageType="ns1:addHotelResponse"/>
        <variable name="AddHotelIn" messageType="ns1:addHotelRequest"/>
        <variable name="CancelPlanningOut" messageType="ns1:cancelPlanningResponse"/>
        <variable name="CancelPlanningIn" messageType="ns1:cancelPlanningRequest"/>
        <variable name="booked" type="xs:boolean"/>
        <variable name="BookItineraryOut" messageType="ns1:bookItineraryResponse"/>
        <variable name="BookItineraryIn" messageType="ns1:bookItineraryRequest"/>
        <variable name="GetItineraryOut" messageType="ns1:getItineraryResponse"/>
        <variable name="GetItineraryIn" messageType="ns1:getItineraryRequest"/>
        <variable name="donePlanning" type="xs:boolean"/>
        <variable name="AddFlightOut" messageType="ns1:addFlightResponse"/>
        <variable name="AddFlightIn" messageType="ns1:addFlightRequest"/>
        <variable name="hotelSize" type="xs:int"/>
        <variable name="flightSize" type="xs:int"/>
        <variable name="itinerary" type="ns1:itineraryType">
            <sxed:editor>
                <sxed:predicate path="$itinerary/hotels[$hotelSize]" source="to"/>
                <sxed:predicate path="$itinerary/flight[$flightSize]" source="to"/>
                <sxed:predicate path="$itinerary/flight[$ForEach1Counter]" source="from"/>
                <sxed:predicate path="$itinerary/flight[$ForEach1Counter]" source="to"/>
            </sxed:editor>
        </variable>
        <variable name="GetFlightsOutWS" xmlns:tns="urn://airlineReservation.imm.dtu.dk" messageType="tns:getFlightsResponse"/>
        <variable name="GetFlightsInWS" xmlns:tns="urn://airlineReservation.imm.dtu.dk" messageType="tns:getFlights"/>
        <variable name="GetFlightsOut" xmlns:tns="http://travelGood.ws" messageType="tns:getFlightsResponse"/>
        <variable name="GetFlightsIn" xmlns:tns="http://travelGood.ws" messageType="tns:getFlightsRequest"/>
        <variable name="CreateItineraryOut" xmlns:tns="http://travelGood.ws" messageType="tns:itineraryResponse"/>
        <variable name="CreateItineraryIn" xmlns:tns="http://travelGood.ws" messageType="tns:itineraryRequest"/>
    </variables>
    <correlationSets>
        <correlationSet name="ItineraryAndCustomer" properties="ns1:customerId ns1:itineraryId"/>
    </correlationSets>
    <sequence>
        <receive name="createItinerary" createInstance="yes" partnerLink="PartnerLink1" operation="createItinerary" xmlns:tns="http://travelGood.ws" portType="tns:travelGoodPortType" variable="CreateItineraryIn">
            <correlations>
                <correlation set="ItineraryAndCustomer" initiate="yes"/>
            </correlations>
        </receive>
        <assign name="createItinearyAssign">
            <copy>
                <from>1</from>
                <to variable="flightSize"/>
            </copy>
            <copy>
                <from>1</from>
                <to variable="hotelSize"/>
            </copy>
            <copy>
                <from>false()</from>
                <to variable="donePlanning"/>
            </copy>
            <copy>
                <from>false()</from>
                <to variable="booked"/>
            </copy>
            <copy>
                <from>true()</from>
                <to variable="CreateItineraryOut" part="status"/>
            </copy>
        </assign>
        <reply name="replyCreateItinerary" partnerLink="PartnerLink1" operation="createItinerary" xmlns:tns="http://travelGood.ws" portType="tns:travelGoodPortType" variable="CreateItineraryOut"/>
        <if name="If1">
            <condition>false() = $booked</condition>
            <repeatUntil name="RepeatTravelGoodProcess" xmlns:tns="urn://airlineReservation.imm.dtu.dk">
                <pick name="ChooseMethod" xmlns:tns="urn://airlineReservation.imm.dtu.dk">
                    <onMessage partnerLink="PartnerLink1" operation="getFlights" portType="ns1:travelGoodPortType" variable="GetFlightsIn">
                            <correlations>
                                    <correlation set="ItineraryAndCustomer" initiate="no"/>
                                </correlations>
                                <sequence name="getFlights">
                                    <assign name="AssignGetfFlights">
                                            <copy>
                                                    <from variable="GetFlightsIn" part="start"/>
                                                        <to>$GetFlightsInWS.parametersGetFlights/ns0:start</to>
                                                </copy>
                                                <copy>
                                                    <from variable="GetFlightsIn" part="end"/>
                                                        <to>$GetFlightsInWS.parametersGetFlights/ns0:end</to>
                                                </copy>
                                                <copy>
                                                    <from variable="GetFlightsIn" part="date"/>
                                                        <to>$GetFlightsInWS.parametersGetFlights/ns0:date</to>
                                                </copy>
                                        </assign>
                                        <invoke name="getFlightsInvoke" partnerLink="PartnerLink2" operation="getFlights" xmlns:tns="urn://airlineReservation.imm.dtu.dk" portType="tns:AirlineReservationPortType" inputVariable="GetFlightsInWS" outputVariable="GetFlightsOutWS"/>
                                        <assign name="getFlightsReplyAssign">
                                            <copy>
                                                    <from>$GetFlightsOutWS.returnGetflights/ns0:flightInformation</from>
                                                        <to>$GetFlightsOut.flights/ns0:flightInformation</to>
                                                </copy>
                                        </assign>
                                        <reply name="ReplyGetFlights" partnerLink="PartnerLink1" operation="getFlights" portType="ns1:travelGoodPortType" variable="GetFlightsOut"/>
                                </sequence>
                        </onMessage>
                        <onMessage partnerLink="PartnerLink1" operation="addFlight" portType="ns1:travelGoodPortType" variable="AddFlightIn">
                            <correlations>
                                    <correlation set="ItineraryAndCustomer" initiate="no"/>
                                </correlations>
                                <sequence name="addFLight">
                                    <assign name="AssignAddItinerary">
                                            <copy>
                                                    <from variable="AddFlightIn" part="bookingNumber"/>
                                                        <to>$itinerary/flight[$flightSize]/bookingNumber
                                            <sxed:editor>
                                                                    <sxed:predicate path="$itinerary/flight[$flightSize]" source="to"/>
                                                                </sxed:editor>
                                                        </to>
                                                </copy>
                                                <copy>
                                                    <from>'unconfirmed'</from>
                                                        <to>$itinerary/flight[$flightSize]/status
                                        <sxed:editor>
                                                                    <sxed:predicate path="$itinerary/flight[$flightSize]" source="to"/>
                                                                </sxed:editor>
                                                        </to>
                                                </copy>
                                                <copy>
                                                    <from>true()</from>
                                                        <to variable="AddFlightOut" part="status"/>
                                                </copy>
                                                <copy>
                                                    <from>$flightSize + 1</from>
                                                        <to variable="flightSize"/>
                                                </copy>
                                        </assign>
                                        <reply name="ReplyAddFlight" partnerLink="PartnerLink1" operation="addFlight" portType="ns1:travelGoodPortType" variable="AddFlightOut"/>
                                </sequence>
                        </onMessage>
                        <onMessage partnerLink="PartnerLink1" operation="getItinerary" portType="ns1:travelGoodPortType" variable="GetItineraryIn">
                            <correlations>
                                    <correlation set="ItineraryAndCustomer" initiate="no"/>
                                </correlations>
                                <sequence name="getItinerary">
                                    <assign name="AssignGetItinerary">
                                            <copy>
                                                    <from variable="itinerary"/>
                                                        <to variable="GetItineraryOut" part="itinerary"/>
                                                </copy>
                                        </assign>
                                        <reply name="ReplyGetItinerary" partnerLink="PartnerLink1" operation="getItinerary" portType="ns1:travelGoodPortType" variable="GetItineraryOut"/>
                                </sequence>
                        </onMessage>
                        <onMessage partnerLink="PartnerLink1" operation="bookItinerary" portType="ns1:travelGoodPortType" variable="BookItineraryIn">
                            <correlations>
                                    <correlation set="ItineraryAndCustomer" initiate="no"/>
                                </correlations>
                                <sequence name="BookItinerary">
                                    <forEach name="ForEachFlight" parallel="no" counterName="ForEach1Counter">
                                            <startCounterValue>1</startCounterValue>
                                                <finalCounterValue>$flightSize - 1</finalCounterValue>
                                                <scope name="BookFlightsScope">
                                                    <variables>
                                                            <variable name="BookFlightOut" messageType="tns:bookFlightResponse"/>
                                                                <variable name="BookFlightIn" messageType="tns:bookFlight"/>
                                                        </variables>
                                                        <sequence name="BookFlights">
                                                            <assign name="AssignFlight">
                                                                    <copy>
                                                                            <from variable="BookItineraryIn" part="creditcard"/>
                                                                                <to>$BookFlightIn.parametersBookFlight/ns0:creditcard</to>
                                                                        </copy>
                                                                        <copy>
                                                                            <from>$itinerary/flight[$ForEach1Counter]/bookingNumber
                                                <sxed:editor>
                                                                                            <sxed:predicate path="$itinerary/flight[$ForEach1Counter]" source="from"/>
                                                                                        </sxed:editor>
                                                                                </from>
                                                                                <to>$BookFlightIn.parametersBookFlight/ns0:bookingNumber</to>
                                                                        </copy>
                                                                </assign>
                                                                <invoke name="BookFlightInvoke" partnerLink="PartnerLink2" operation="bookFlight" portType="tns:AirlineReservationPortType" inputVariable="BookFlightIn" outputVariable="BookFlightOut"/>
                                                                <assign name="setFlightBooked">
                                                                    <copy>
                                                                            <from>'confirmed'</from>
                                                                                <to>$itinerary/flight[$ForEach1Counter]/status
                                                <sxed:editor>
                                                                                            <sxed:predicate path="$itinerary/flight[$ForEach1Counter]" source="to"/>
                                                                                        </sxed:editor>
                                                                                </to>
                                                                        </copy>
                                                                </assign>
                                                        </sequence>
                                                </scope>
                                        </forEach>
                                        <assign name="setBooked">
                                            <copy>
                                                    <from>true()</from>
                                                        <to variable="BookItineraryOut" part="status"/>
                                                </copy>
                                                <copy>
                                                    <from>true()</from>
                                                        <to variable="booked"/>
                                                </copy>
                                        </assign>
                                        <reply name="bookItineraryReply" partnerLink="PartnerLink1" operation="bookItinerary" portType="ns1:travelGoodPortType" variable="BookItineraryOut"/>
                                </sequence>
                        </onMessage>
                        <onMessage partnerLink="PartnerLink1" operation="cancelPlanning" portType="ns1:travelGoodPortType" variable="CancelPlanningIn">
                            <correlations>
                                    <correlation set="ItineraryAndCustomer" initiate="no"/>
                                </correlations>
                                <sequence name="CancelPlanningSequence">
                                    <assign name="AssignCancelPlanning">
                                            <copy>
                                                    <from>true()</from>
                                                        <to variable="donePlanning"/>
                                                </copy>
                                                <copy>
                                                    <from>true()</from>
                                                        <to variable="CancelPlanningOut" part="response"/>
                                                </copy>
                                        </assign>
                                        <reply name="CancelPlanningReply" partnerLink="PartnerLink1" operation="cancelPlanning" portType="ns1:travelGoodPortType" variable="CancelPlanningOut"/>
                                </sequence>
                        </onMessage>
                        <onMessage partnerLink="PartnerLink1" operation="addHotel" portType="ns1:travelGoodPortType" variable="AddHotelIn">
                            <correlations>
                                    <correlation set="ItineraryAndCustomer" initiate="no"/>
                                </correlations>
                                <sequence name="AddHotel">
                                    <assign name="addingHotel">
                                            <copy>
                                                    <from>true()</from>
                                                        <to variable="AddHotelOut" part="status"/>
                                                </copy>
                                                <copy>
                                                    <from variable="AddHotelIn" part="bookingNumber"/>
                                                        <to>$itinerary/hotels[$hotelSize]/bookingNumber
                                    <sxed:editor>
                                                                    <sxed:predicate path="$itinerary/hotels[$hotelSize]" source="to"/>
                                                                </sxed:editor>
                                                        </to>
                                                </copy>
                                                <copy>
                                                    <from>'unconfirmed'</from>
                                                        <to>$itinerary/hotels[$hotelSize]/status
                                    <sxed:editor>
                                                                    <sxed:predicate path="$itinerary/hotels[$hotelSize]" source="to"/>
                                                                </sxed:editor>
                                                        </to>
                                                </copy>
                                                <copy>
                                                    <from>$hotelSize + 1</from>
                                                        <to variable="hotelSize"/>
                                                </copy>
                                        </assign>
                                        <reply name="ReplyAddHotel" partnerLink="PartnerLink1" operation="addHotel" portType="ns1:travelGoodPortType" variable="AddHotelOut"/>
                                </sequence>
                        </onMessage>
                </pick>
                    <condition>$donePlanning</condition>
            </repeatUntil>
            <else>
                <sequence name="CancelItinerary">
                    <receive name="ReceiveCancelItinerary" partnerLink="PartnerLink1" operation="cancelItinerary" portType="ns1:travelGoodPortType" createInstance="no" variable="CancelItineraryIn">
                        <correlations>
                            <correlation set="ItineraryAndCustomer" initiate="no"/>
                        </correlations>
                    </receive>
                    <reply name="ReplyCancelItinerary" partnerLink="PartnerLink1" operation="cancelItinerary" portType="ns1:travelGoodPortType" variable="CancelItineraryOut1"/>
                </sequence>
            </else>
        </if>
    </sequence>
</process>
