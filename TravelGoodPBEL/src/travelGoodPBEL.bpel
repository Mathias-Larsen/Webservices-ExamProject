<?xml version="1.0" encoding="UTF-8" ?>
<process
    name="travelGoodPBEL"
    targetNamespace="http://enterprise.netbeans.org/bpel/TravelGoodPBEL/travelGoodPBEL"
    xmlns:tns="http://enterprise.netbeans.org/bpel/TravelGoodPBEL/travelGoodPBEL"
    xmlns:xs="http://www.w3.org/2001/XMLSchema"
    xmlns:xsd="http://www.w3.org/2001/XMLSchema"
    xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
    xmlns:sxt="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/Trace" 
    xmlns:sxed="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/Editor2"
    xmlns:sxat="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/Attachment"
    xmlns:sxeh="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/ErrorHandling" xmlns:ns0="urn://types.airlineReservation.imm.dtu.dk" xmlns:ns1="http://travelGood.ws" xmlns:sxxf="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/XPathFunctions">
    <import namespace="http://travelGood.ws" location="travelGood.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="urn://airlineReservation.imm.dtu.dk" location="http://localhost:8080/AirlineReservation/AirlineReservationService?wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <partnerLinks>
        <partnerLink name="PartnerLink2" xmlns:tns="urn://airlineReservation.imm.dtu.dk" partnerLinkType="tns:AirlineReservationLink" partnerRole="AirlineReservationRole"/>
        <partnerLink name="PartnerLink1" xmlns:tns="http://travelGood.ws" partnerLinkType="tns:travelGood" myRole="travelGoodPortTypeRole"/>
    </partnerLinks>
    <variables>
        <variable name="AddBookingOut" messageType="ns1:addBookingResponse"/>
        <variable name="AddBookingIn" messageType="ns1:addBookingRequest"/>
        
          <variable name="numberOfBookedBookings" type="xs:int"/>
          <variable name="CancelItineraryOut" messageType="ns1:cancelItineraryResponse"/>
        <variable name="CancelItineraryIn" messageType="ns1:cancelItineraryRequest"/>
        <variable name="CancelPlanningOut" messageType="ns1:cancelPlanningResponse"/>
        <variable name="CancelPlanningIn" messageType="ns1:cancelPlanningRequest"/>
        <variable name="BookItineraryOut" messageType="ns1:bookItineraryResponse"/>
        <variable name="BookItineraryIn" messageType="ns1:bookItineraryRequest"/>
        <variable name="GetItineraryOut" messageType="ns1:getItineraryResponse"/>
        <variable name="GetItineraryIn" messageType="ns1:getItineraryRequest"/>
        <variable name="bookingSize" type="xs:int"/>
        <variable name="itinerary" type="ns1:itineraryType">
            <sxed:editor>
                <sxed:predicate path="$itinerary/bookings[$bookingSize]" source="to"/>
                 <sxed:predicate path="$itinerary/bookings[$ForEach1Counter]" source="to"/>
                 <sxed:predicate path="$itinerary/bookings[$cancelFlightVariable]" source="from"/>
                 <sxed:predicate path="$itinerary/bookings[$cancelFlightVariable]" source="to"/>
                 <sxed:predicate path="$itinerary/bookings[$ForEachFlightCancel]" source="from"/>
                 <sxed:predicate path="$itinerary/bookings[$ForEach1Counter]" source="from"/>
                 <sxed:predicate path="$itinerary/bookings[$ForEachFlightCancel]" source="to"/>
            </sxed:editor>
        </variable>
        <variable name="GetFlightsOutWS" xmlns:tns="urn://airlineReservation.imm.dtu.dk" messageType="tns:getFlightsResponse"/>
        <variable name="GetFlightsInWS" xmlns:tns="urn://airlineReservation.imm.dtu.dk" messageType="tns:getFlights"/>
        <variable name="GetFlightsOut" xmlns:tns="http://travelGood.ws" messageType="tns:getFlightsResponse"/>
        <variable name="GetFlightsIn" xmlns:tns="http://travelGood.ws" messageType="tns:getFlightsRequest"/>
        <variable name="CreateItineraryOut" xmlns:tns="http://travelGood.ws" messageType="tns:itineraryResponse"/>
        <variable name="CreateItineraryIn" xmlns:tns="http://travelGood.ws" messageType="tns:itineraryRequest"/>
    </variables>
    <correlationSets>
        <correlationSet name="ItineraryAndCustomer" properties="ns1:customerId ns1:itineraryId"/>
    </correlationSets>
    <sequence>
        <receive name="createItinerary" createInstance="yes" partnerLink="PartnerLink1" operation="createItinerary" xmlns:tns="http://travelGood.ws" portType="tns:travelGoodPortType" variable="CreateItineraryIn">
            <correlations>
                <correlation set="ItineraryAndCustomer" initiate="yes"/>
            </correlations>
        </receive>
        <assign name="createItinearyAssign">
            <copy>
                <from>true()</from>
                <to variable="CreateItineraryOut" part="status"/>
            </copy>
            <copy>
                <from>'null'</from>
                <to>$itinerary/itineraryStartDate</to>
            </copy>
            <copy>
                <from>'planning'</from>
                <to>$itinerary/status</to>
            </copy>
            <copy>
                <from>1</from>
                <to variable="bookingSize"/>
            </copy>
        </assign>
        <reply name="replyCreateItinerary" partnerLink="PartnerLink1" operation="createItinerary" xmlns:tns="http://travelGood.ws" portType="tns:travelGoodPortType" variable="CreateItineraryOut"/>
        <repeatUntil name="RepeatTravelGoodProcessUntilDone" xmlns:tns="urn://airlineReservation.imm.dtu.dk">
              <sequence name="TravelGoodServices">
                   <pick name="ChooseMethod">
                      <onMessage partnerLink="PartnerLink1" operation="getFlights" portType="ns1:travelGoodPortType" variable="GetFlightsIn">
                              <correlations>
                                      <correlation set="ItineraryAndCustomer" initiate="no"/>
                                  </correlations>
                                  <sequence name="getFlights">
                                      <if name="If2">
                                          <condition>$itinerary/status = 'planning'</condition>
                                          <sequence name="Sequence3">
                                              <assign name="AssignGetfFlights">
                                                  <copy>
                                                      <from variable="GetFlightsIn" part="start"/>
                                                          <to>$GetFlightsInWS.parametersGetFlights/ns0:start</to>
                                                  </copy>
                                                      <copy>
                                                      <from variable="GetFlightsIn" part="end"/>
                                                          <to>$GetFlightsInWS.parametersGetFlights/ns0:end</to>
                                                  </copy>
                                                      <copy>
                                                      <from variable="GetFlightsIn" part="date"/>
                                                          <to>$GetFlightsInWS.parametersGetFlights/ns0:date</to>
                                                  </copy>
                                              </assign>
                                              <invoke name="getFlightsInvoke" partnerLink="PartnerLink2" operation="getFlights" portType="tns:AirlineReservationPortType" inputVariable="GetFlightsInWS" outputVariable="GetFlightsOutWS"/>
                                              <assign name="getFlightsReplyAssign">
                                                  <copy>
                                                      <from>$GetFlightsOutWS.returnGetflights/ns0:flightInformation</from>
                                                          <to>$GetFlightsOut.flights/ns0:flightInformation</to>
                                                  </copy>
                                              </assign>
                                          </sequence>
                                          <else>
                                              <assign name="setFalseGetFlights">
                                                  <copy>
                                                      <from>'null'</from>
                                                      <to variable="GetFlightsOut" part="flights"/>
                                                  </copy>
                                              </assign>
                                          </else>
                                      </if>
                                      <reply name="ReplyGetFlights" partnerLink="PartnerLink1" operation="getFlights" portType="ns1:travelGoodPortType" variable="GetFlightsOut"/>
                                  </sequence>
                          </onMessage>
                          <onMessage partnerLink="PartnerLink1" operation="addBooking" portType="ns1:travelGoodPortType" variable="AddBookingIn">
                              <correlations>
                                  <correlation set="ItineraryAndCustomer" initiate="no"/>
                              </correlations>
                                  <sequence name="addBooking">
                                      <if name="If3">
                                          <condition>$itinerary/status = 'planning'</condition>
                                           <sequence name="Sequence9">
                                                <if name="dateEqualsNull">
                                                     <condition>'null' = $itinerary/itineraryStartDate</condition>
                                                          <assign name="AssignAddItinerary">
                                                               <copy>
                                                                         <from variable="AddBookingIn" part="bookingNumber"/>
                                                                              <to>$itinerary/bookings[$bookingSize]/bookingNumber
                                            <sxed:editor>
                                                                                             <sxed:predicate path="$itinerary/flight[$flightSize]" source="to"/>
                                                                                        </sxed:editor>
                                                                              </to>
                                                                    </copy>
                                                                    <copy>
                                                                         <from>'unconfirmed'</from>
                                                                              <to>$itinerary/bookings[$bookingSize]/status
                                        <sxed:editor>
                                                                                             <sxed:predicate path="$itinerary/bookings[$bookingSize]" source="to"/>
                                                                                        </sxed:editor>
                                                                              </to>
                                                                    </copy>
                                                                    <copy>
                                                                         <from>true()</from>
                                                                              <to variable="AddBookingOut" part="status"/>
                                                                    </copy>
                                                                    <copy>
                                                                         <from variable="AddBookingIn" part="date"/>
                                                                              <to>$itinerary/itineraryStartDate</to>
                                                                    </copy>
                                                                    <copy>
                                                                         <from variable="AddBookingIn" part="type"/>
                                                                              <to>$itinerary/bookings[$bookingSize]/type
                                                                 <sxed:editor>
                                                                                             <sxed:predicate path="$itinerary/bookings[$bookingSize]" source="to"/>
                                                                                        </sxed:editor>
                                                                              </to>
                                                                    </copy>
                                                          </assign>
                                                          <elseif>
                                                               <condition>sxxf:date-less-than($AddBookingIn.date, $itinerary/itineraryStartDate)</condition>
                                                                    <assign name="AssignAddItinerary2">
                                                                         <copy>
                                                                                   <from variable="AddBookingIn" part="bookingNumber"/>
                                                                                        <to>$itinerary/bookings[$bookingSize]/bookingNumber
                                            <sxed:editor>
                                                                                                       <sxed:predicate path="$itinerary/flight[$flightSize]" source="to"/>
                                                                                                  </sxed:editor>
                                                                                        </to>
                                                                              </copy>
                                                                              <copy>
                                                                                   <from>'unconfirmed'</from>
                                                                                        <to>$itinerary/bookings[$bookingSize]/status
                                        <sxed:editor>
                                                                                                       <sxed:predicate path="$itinerary/bookings[$bookingSize]" source="to"/>
                                                                                                  </sxed:editor>
                                                                                        </to>
                                                                              </copy>
                                                                              <copy>
                                                                                   <from>true()</from>
                                                                                        <to variable="AddBookingOut" part="status"/>
                                                                              </copy>
                                                                              <copy>
                                                                                   <from variable="AddBookingIn" part="date"/>
                                                                                        <to>$itinerary/itineraryStartDate</to>
                                                                              </copy>
                                                                              <copy>
                                                                                   <from variable="AddBookingIn" part="type"/>
                                                                                        <to>$itinerary/bookings[$bookingSize]/type
                                                                                     <sxed:editor>
                                                                                                       <sxed:predicate path="$itinerary/bookings[$bookingSize]" source="to"/>
                                                                                                  </sxed:editor>
                                                                                        </to>
                                                                              </copy>
                                                                    </assign>
                                                          </elseif>
                                                          <else>
                                                               <assign name="AssignAddItinerary3">
                                                                         <copy>
                                                                                   <from variable="AddBookingIn" part="bookingNumber"/>
                                                                                        <to>$itinerary/bookings[$bookingSize]/bookingNumber
                                            <sxed:editor>
                                                                                                       <sxed:predicate path="$itinerary/flight[$flightSize]" source="to"/>
                                                                                                  </sxed:editor>
                                                                                        </to>
                                                                              </copy>
                                                                              <copy>
                                                                                   <from>'unconfirmed'</from>
                                                                                        <to>$itinerary/bookings[$bookingSize]/status
                                        <sxed:editor>
                                                                                                       <sxed:predicate path="$itinerary/bookings[$bookingSize]" source="to"/>
                                                                                                  </sxed:editor>
                                                                                        </to>
                                                                              </copy>
                                                                              <copy>
                                                                                   <from>true()</from>
                                                                                        <to variable="AddBookingOut" part="status"/>
                                                                              </copy>
                                                                              <copy>
                                                                                   <from variable="AddBookingIn" part="type"/>
                                                                                        <to>$itinerary/bookings[$bookingSize]/type
                                                                                  <sxed:editor>
                                                                                                       <sxed:predicate path="$itinerary/bookings[$bookingSize]" source="to"/>
                                                                                                  </sxed:editor>
                                                                                        </to>
                                                                              </copy>
                                                                    </assign>
                                                          </else>
                                                </if>
                                                <assign name="setBookingSizePlusOne">
                                                     <copy>
                                                          <from>$bookingSize + 1</from>
                                                          <to variable="bookingSize"/>
                                                     </copy>
                                                </assign>
                                           </sequence>
                                           <else>
                                                <assign name="setFalseBooking">
                                                     <copy>
                                                          <from>false()</from>
                                                          <to variable="AddBookingOut" part="status"/>
                                                     </copy>
                                                </assign>
                                           </else>
                                      </if>
                                          <reply name="ReplyAddFlight" partnerLink="PartnerLink1" operation="addBooking" portType="ns1:travelGoodPortType" variable="AddBookingOut"/>
                                  </sequence>
                          </onMessage>
                          <onMessage partnerLink="PartnerLink1" operation="getItinerary" portType="ns1:travelGoodPortType" variable="GetItineraryIn">
                              <correlations>
                                      <correlation set="ItineraryAndCustomer" initiate="no"/>
                                  </correlations>
                                  <sequence name="getItinerary">
                                      <assign name="AssignGetItinerary">
                                              <copy>
                                                      <from variable="itinerary"/>
                                                          <to variable="GetItineraryOut" part="itinerary"/>
                                                  </copy>
                                          </assign>
                                          <reply name="ReplyGetItinerary" partnerLink="PartnerLink1" operation="getItinerary" portType="ns1:travelGoodPortType" variable="GetItineraryOut"/>
                                  </sequence>
                          </onMessage>
                          <onMessage partnerLink="PartnerLink1" operation="bookItinerary" portType="ns1:travelGoodPortType" variable="BookItineraryIn">
                              <correlations>
                                      <correlation set="ItineraryAndCustomer" initiate="no"/>
                                  </correlations>
                                  <sequence name="BookItinerary">
                                      <if name="IfPlanning">
                                           <condition>'planning' = $itinerary/status</condition>
                                           <sequence name="Sequence4">
                                              <scope name="ScopeBook">
                                                  <faultHandlers>
                                                      <catch faultName="tns:bookFlightFaultMessage">
                                                              <compensate name="Compensate1"/>
                                                          </catch>
                                                  </faultHandlers>
                                                      <sequence name="SequenceBook">
                                                           <assign name="setBooked">
                                                                <copy>
                                                                          <from>true()</from>
                                                                               <to variable="BookItineraryOut" part="status"/>
                                                                     </copy>
                                                                     <copy>
                                                                          <from>'booked'</from>
                                                                               <to>$itinerary/status</to>
                                                                     </copy>
                                                           </assign>
                                                           <forEach name="ForEachBooking" parallel="no" counterName="ForEach1Counter">
                                                              <startCounterValue>1</startCounterValue>
                                                           <finalCounterValue>$bookingSize - 1</finalCounterValue>
                                                           <scope name="BookingScope">
                                                                      <variables>
                                                                              <variable name="BookFlightOut" messageType="tns:bookFlightResponse"/>
                                                                                  <variable name="BookFlightIn" messageType="tns:bookFlight"/>
                                                                          </variables>
                                                                          <compensationHandler>
                                                                              <sequence name="SequenceCancelBookings">
                                                                                      <forEach name="ForEachBookingToCancel" parallel="no" counterName="cancelFlightVariable">
                                                                                              <startCounterValue>1</startCounterValue>
                                                                                           <finalCounterValue>$numberOfBookedBookings</finalCounterValue>
                                                                                           <scope name="ScopeCancelBookedBookings">
                                                                                                      <variables>
                                                                                                              <variable name="CancelFlightOut" messageType="tns:cancelFlightResponse"/>
                                                                                                                  <variable name="CancelFlightIn" messageType="tns:cancelFlight"/>
                                                                                                          </variables>
                                                                                                          <sequence name="SequenceCancelF">
                                                                                                              <assign name="AssignCancelFlight">
                                                                               
                                                                                                                          <copy>
                                                                                                                              <from variable="BookItineraryIn" part="creditcard"/>
                                                                                                                                  <to>$CancelFlightIn.parametersCancelFlight/ns0:creditcard</to>
                                                                                                                          </copy>
                                                                                                                   <copy>
                                                                                                                        <from>$itinerary/bookings[$cancelFlightVariable]/bookingNumber
                                                                                                                             <sxed:editor>
                                                                                                                                  <sxed:predicate path="$itinerary/bookings[$cancelFlightVariable]" source="from"/>
                                                                                                                             </sxed:editor>
                                                                                                                        </from>
                                                                                                                        <to>$CancelFlightIn.parametersCancelFlight/ns0:bookingNumber</to>
                                                                                                                   </copy>
                                                                                                                   <copy>
                                                                                                                        <from>'cancelled'</from>
                                                                                                                        <to>$itinerary/bookings[$cancelFlightVariable]/status
                                                                                                                             <sxed:editor>
                                                                                                                                  <sxed:predicate path="$itinerary/bookings[$cancelFlightVariable]" source="to"/>
                                                                                                                             </sxed:editor>
                                                                                                                        </to>
                                                                                                                   </copy>
                                                                                                                   <copy>
                                                                                                                        <from>'planning'</from>
                                                                                                                        <to>$itinerary/status</to>
                                                                                                                   </copy>
                                                                                                              </assign>
                                                                                                                  <invoke name="InvokeCancelFlight" partnerLink="PartnerLink2" operation="cancelFlight" portType="tns:AirlineReservationPortType" inputVariable="CancelFlightIn" outputVariable="CancelFlightOut"/>
                                                                                                          </sequence>
                                                                                                  </scope>
                                                                                          </forEach>
                                                                                          <assign name="setCancelled">
                                                                                              <copy>
                                                                                                      <from>false()</from>
                                                                                                          <to variable="BookItineraryOut" part="status"/>
                                                                                                  </copy>
                                                                                          </assign>
                                                                                  </sequence>
                                                                          </compensationHandler>
                                                                          <sequence name="BookFlights">
                                                                              <assign name="AssignFlight">
                                                                                   <copy>
                                                                                        <from variable="BookItineraryIn" part="creditcard"/>
                                                                                        <to>$BookFlightIn.parametersBookFlight/ns0:creditcard</to>
                                                                                   </copy>
                                                                                   <copy>
                                                                                        <from>$itinerary/bookings[$ForEach1Counter]/bookingNumber
                                                                                             <sxed:editor>
                                                                                                  <sxed:predicate path="$itinerary/bookings[$ForEach1Counter]" source="from"/>
                                                                                             </sxed:editor>
                                                                                        </from>
                                                                                        <to>$BookFlightIn.parametersBookFlight/ns0:bookingNumber</to>
                                                                                   </copy>
                                                                              </assign>
                                                                                  <invoke name="BookFlightInvoke" partnerLink="PartnerLink2" operation="bookFlight" portType="tns:AirlineReservationPortType" inputVariable="BookFlightIn" outputVariable="BookFlightOut"/>
                                                                                  <assign name="setFlightBooked">
                                                                                       <copy>
                                                                                            <from>'confirmed'</from>
                                                                                            <to>$itinerary/bookings[$ForEach1Counter]/status
                                                                                                 <sxed:editor>
                                                                                                      <sxed:predicate path="$itinerary/bookings[$ForEach1Counter]" source="to"/>
                                                                                                 </sxed:editor>
                                                                                            </to>
                                                                                       </copy>
                                                                                       <copy>
                                                                                            <from variable="ForEach1Counter"/>
                                                                                            <to variable="numberOfBookedBookings"/>
                                                                                       </copy>
                                                                                  </assign>
                                                                          </sequence>
                                                                  </scope>
                                                          </forEach>
                                                  </sequence>
                                              </scope>
                                          </sequence>
                                          <else>
                                              <assign name="Assign3">
                                                  <copy>
                                                      <from>false()</from>
                                                      <to variable="BookItineraryOut" part="status"/>
                                                  </copy>
                                              </assign>
                                          </else>
                                      </if>
                                          <reply name="bookItineraryReply" partnerLink="PartnerLink1" operation="bookItinerary" portType="ns1:travelGoodPortType" variable="BookItineraryOut"/>
                                  </sequence>
                          </onMessage>
                          <onMessage partnerLink="PartnerLink1" operation="cancelPlanning" portType="ns1:travelGoodPortType" variable="CancelPlanningIn">
                              <correlations>
                                      <correlation set="ItineraryAndCustomer" initiate="no"/>
                                  </correlations>
                                  <sequence name="CancelPlanningSequence">
                                      <if name="If5">
                                           <condition>$itinerary/status = 'planning'</condition>
                                           <assign name="AssignCancelPlanning">
                                              <copy>
                                                      <from>true()</from>
                                                          <to variable="CancelPlanningOut" part="response"/>
                                                  </copy>
                                                <copy>
                                                     <from>'PlanningCancelled'</from>
                                                     <to>$itinerary/status</to>
                                                </copy>
                                           </assign>
                                          <else>
                                              <assign name="setNotAllowed">
                                                  <copy>
                                                      <from>false()</from>
                                                      <to variable="CancelPlanningOut" part="response"/>
                                                  </copy>
                                              </assign>
                                          </else>
                                      </if>
                                          <reply name="CancelPlanningReply" partnerLink="PartnerLink1" operation="cancelPlanning" portType="ns1:travelGoodPortType" variable="CancelPlanningOut"/>
                                  </sequence>
                          </onMessage>
                      <onMessage partnerLink="PartnerLink1" operation="cancelItinerary" portType="ns1:travelGoodPortType" variable="CancelItineraryIn">
                          <correlations>
                              <correlation set="ItineraryAndCustomer" initiate="no"/>
                          </correlations>
                          <sequence name="Sequence5">
                              <if name="If6">
                                   <condition>$itinerary/status = 'booked'</condition>
                                   <sequence name="Sequence7">
                                      <assign name="setItineraryCancelled">
                                          <copy>
                                              <from>true()</from>
                                              <to variable="CancelItineraryOut" part="status"/>
                                          </copy>
                                           <copy>
                                                <from>'cancelled'</from>
                                                <to>$itinerary/status</to>
                                           </copy>
                                      </assign>
                                      <forEach name="ForEachFlightCancel" parallel="no" counterName="ForEachFlightCancel">
                                          <startCounterValue>1</startCounterValue>
                                           <finalCounterValue>$bookingSize - 1</finalCounterValue>
                                           <scope name="ScopeCancelBookings">
                                                  <variables>
                                                          <variable name="CancelFlightOut" messageType="tns:cancelFlightResponse"/>
                                                              <variable name="CancelFlightIn" messageType="tns:cancelFlight"/>
                                                      </variables>
                                                      <sequence name="Sequence6">
                                                          <scope name="Scope2">
                                                              <faultHandlers>
                                                                  <catch faultName="tns:cancelFlightFaultMessage">
                                                                      <assign name="setFault">
                                                                          <copy>
                                                                              <from>false()</from>
                                                                              <to variable="CancelItineraryOut" part="status"/>
                                                                          </copy>
                                                                           <copy>
                                                                                <from>'planning'</from>
                                                                                <to>$itinerary/status</to>
                                                                           </copy>
                                                                      </assign>
                                                                  </catch>
                                                              </faultHandlers>
                                                              <sequence name="Sequence8">
                                                                   <assign name="Assign12">
                                                                        <copy>
                                                                             <from>$itinerary/bookings[$ForEachFlightCancel]/bookingNumber
                                                                                  <sxed:editor>
                                                                                       <sxed:predicate path="$itinerary/bookings[$ForEachFlightCancel]" source="from"/>
                                                                                  </sxed:editor>
                                                                             </from>
                                                                             <to>$CancelFlightIn.parametersCancelFlight/ns0:bookingNumber</to>
                                                                        </copy>
                                                                        <copy>
                                                                             <from variable="CancelItineraryIn" part="creditcard"/>
                                                                             <to>$CancelFlightIn.parametersCancelFlight/ns0:creditcard</to>
                                                                        </copy>
                                                                   </assign>
                                                                   <invoke name="InvokeCancelFlight" partnerLink="PartnerLink2" operation="cancelFlight" portType="tns:AirlineReservationPortType" inputVariable="CancelFlightIn" outputVariable="CancelFlightOut"/>
                                                                   <assign name="setCancelled">
                                                                        <copy>
                                                                             <from>'cancelled'</from>
                                                                             <to>$itinerary/bookings[$ForEachFlightCancel]/status
                                                                                  <sxed:editor>
                                                                                       <sxed:predicate path="$itinerary/bookings[$ForEachFlightCancel]" source="to"/>
                                                                                  </sxed:editor>
                                                                             </to>
                                                                        </copy>
                                                                   </assign>
                                                              </sequence>
                                                          </scope>
                                                      </sequence>
                                              </scope>
                                      </forEach>
                                  </sequence>
                                  <else>
                                      <assign name="setNotAllowed2">
                                          <copy>
                                              <from>false()</from>
                                              <to variable="CancelPlanningOut" part="response"/>
                                          </copy>
                                      </assign>
                                  </else>
                              </if>
                              <reply name="Reply1" partnerLink="PartnerLink1" operation="cancelItinerary" portType="ns1:travelGoodPortType" variable="CancelItineraryOut"/>
                          </sequence>
                      </onMessage>
                  </pick>
              </sequence>
            <condition>$itinerary/status = 'PlanningCancelled'</condition>
        </repeatUntil>
    </sequence>
</process>
